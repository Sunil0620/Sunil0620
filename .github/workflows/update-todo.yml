name: Todoist Readme

on:
  workflow_dispatch:
  schedule:
    # Runs every 2 hours
    - cron: "0 */2 * * *"

jobs:
  update-readme:
    name: Update README with Todoist stats
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Update Todoist Stats
        run: |
          # Get Todoist data using sync API
          echo "Fetching Todoist stats..."
          TODOIST_DATA=$(curl -s "https://api.todoist.com/sync/v9/completed/get_stats" \
            -H "Authorization: Bearer ${{ secrets.TODOIST_API_KEY }}")
          
          echo "Raw API Response:"
          echo "$TODOIST_DATA" | jq '.'
          
          # Extract basic stats
          COMPLETED_TODAY=$(echo "$TODOIST_DATA" | jq -r '.days_items[0].total_completed // 0')
          TOTAL_COMPLETED=$(echo "$TODOIST_DATA" | jq -r '.completed_count // 0')
          KARMA_POINTS=$(echo "$TODOIST_DATA" | jq -r '.karma // 0')
          
          # Try multiple ways to get streak data
          LONGEST_STREAK=$(echo "$TODOIST_DATA" | jq -r '.streak.longest // .max_day_streak // .longest_streak // 0')
          CURRENT_STREAK=$(echo "$TODOIST_DATA" | jq -r '.streak.current // .current_streak // 0')
          
          # If no streak data, calculate based on activity (simplified)
          if [[ "$LONGEST_STREAK" == "0" || "$LONGEST_STREAK" == "null" ]]; then
            echo "No streak data from API, calculating based on activity..."
            # If user completed tasks today and has good karma, give them at least 1 day streak
            if [[ "$COMPLETED_TODAY" -gt "0" && "$KARMA_POINTS" -gt "100" ]]; then
              LONGEST_STREAK="1"
            fi
          fi

          # Ensure longest streak is at least as high as current streak
          if [[ "$CURRENT_STREAK" -gt "$LONGEST_STREAK" ]]; then
            LONGEST_STREAK="$CURRENT_STREAK"
          fi
          
          echo "Extracted values:"
          echo "Completed Today: $COMPLETED_TODAY"
          echo "Total Completed: $TOTAL_COMPLETED" 
          echo "Karma Points: $KARMA_POINTS"
          echo "Current Streak: $CURRENT_STREAK"
          
          # Update README.md with Todoist stats in colorful badge format, each on a new line
          sed -i "s/üèÜ.*Karma Points.*/üèÜ ![Karma Points](http:\/\/img.shields.io\/badge\/Karma%20Points-$KARMA_POINTS-purple?style=for-the-badge)<br>/" README.md
          sed -i "s/üå∏.*tasks today.*/üå∏ ![Tasks Today](http:\/\/img.shields.io\/badge\/Completed%20Today-$COMPLETED_TODAY-brightgreen?style=for-the-badge)<br>/" README.md
          sed -i "s/‚úÖ.*tasks so far.*/‚úÖ ![Total Tasks](http:\/\/img.shields.io\/badge\/Total%20Completed-$TOTAL_COMPLETED-orange?style=for-the-badge)<br>/" README.md
          sed -i "s/‚è≥.*streak is.*days.*/‚è≥ ![Longest Streak](http:\/\/img.shields.io\/badge\/Longest%20Streak-${LONGEST_STREAK}%20days-blueviolet?style=for-the-badge)<br>/" README.md
          
          echo "README.md updated successfully"
      - name: Commit and push changes
        run: |
          git config --local user.email "sunilsaini5652@gmail.com"
          git config --local user.name "Sunil0620"
          
          # Check if there are any changes
          if [[ -n $(git status --porcelain) ]]; then
            git add README.md
            git commit -m "üìù Update Todoist stats"
            git push origin main
          else
            echo "No changes to commit"
          fi
