name: Todoist Readme

on:
  workflow_dispatch:
  schedule:
    # Runs every 2 hours
    - cron: "0 */2 * * *"

jobs:
  update-readme:
    name: Update README with Todoist stats
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Update Todoist Stats
        run: |
          # Get Todoist data using sync API
          TODOIST_DATA=$(curl -s "https://api.todoist.com/sync/v9/completed/get_stats" \
            -H "Authorization: Bearer ${{ secrets.TODOIST_API_KEY }}")
          
          COMPLETED_TODAY=$(echo "$TODOIST_DATA" | jq -r '.days_items[0].total_completed // 0')
          TOTAL_COMPLETED=$(echo "$TODOIST_DATA" | jq -r '.completed_count // 0')
          KARMA_POINTS=$(echo "$TODOIST_DATA" | jq -r '.karma // 0')
          
          # Calculate longest streak (simplified)
          LONGEST_STREAK=$(echo "$TODOIST_DATA" | jq -r '.max_day_streak // 0')
          
          # Update README.md with Todoist stats
          sed -i "s/üèÜ.*Karma Points/üèÜ  $KARMA_POINTS Karma Points/" README.md
          sed -i "s/üå∏.*tasks today/üå∏  Completed $COMPLETED_TODAY tasks today/" README.md
          sed -i "s/‚úÖ.*tasks so far/‚úÖ  Completed $TOTAL_COMPLETED tasks so far/" README.md
          sed -i "s/‚è≥.*streak is.*days/‚è≥  Longest streak is $LONGEST_STREAK days/" README.md
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "üìù Update Todoist stats"
          file_pattern: "README.md"
          push_options: --force
          