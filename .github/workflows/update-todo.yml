name: Todoist Readme

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */2 * * *" # Runs every 2 hours

jobs:
  update-readme:
    name: Update README with Todoist stats
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch Todoist Stats
        run: |
          echo "Fetching Todoist stats..."
          TODOIST_DATA=$(curl -s "https://api.todoist.com/sync/v9/completed/get_stats" \
            -H "Authorization: Bearer ${{ secrets.TODOIST_API_KEY }}")

          if [[ -z "$TODOIST_DATA" || "$TODOIST_DATA" == "null" ]]; then
            echo "Failed to fetch data from Todoist API"
            exit 1
          fi

          COMPLETED_TODAY=$(echo "$TODOIST_DATA" | jq -r '.days_items[0].total_completed // 0')
          TOTAL_COMPLETED=$(echo "$TODOIST_DATA" | jq -r '.completed_count // 0')
          KARMA_POINTS=$(echo "$TODOIST_DATA" | jq -r '.karma // 0')
          LONGEST_STREAK=$(echo "$TODOIST_DATA" | jq -r '.max_day_streak // 0')
          CURRENT_STREAK=$(echo "$TODOIST_DATA" | jq -r '.current_day_streak // 0')

          if [[ "$CURRENT_STREAK" -gt "$LONGEST_STREAK" ]]; then
            LONGEST_STREAK="$CURRENT_STREAK"
          fi

          # Trim decimals if any
          COMPLETED_TODAY=${COMPLETED_TODAY%.*}
          TOTAL_COMPLETED=${TOTAL_COMPLETED%.*}
          KARMA_POINTS=${KARMA_POINTS%.*}
          LONGEST_STREAK=${LONGEST_STREAK%.*}

          echo "‚úÖ Stats:"
          echo "  - Completed Today: $COMPLETED_TODAY"
          echo "  - Total Completed: $TOTAL_COMPLETED"
          echo "  - Karma Points: $KARMA_POINTS"
          echo "  - Longest Streak: $LONGEST_STREAK days"

          if [[ ! -f README.md ]]; then
            echo "README.md not found!"
            exit 1
          fi

          # Create new stats block
          NEW_BLOCK="üèÜ Karma Points: **$KARMA_POINTS**  \nüå∏ Completed Today: **$COMPLETED_TODAY**  \n‚úÖ Total Completed: **$TOTAL_COMPLETED**  \n‚è≥ Longest Streak: **${LONGEST_STREAK} days**"

          # Safely replace block between <!-- TODO-START --> and <!-- TODO-END -->
          awk -v block="$NEW_BLOCK" '
            BEGIN { start=0 }
            /<!-- TODO-START -->/ { print; start=1; next }
            /<!-- TODO-END -->/ { start=0; print block; print; next }
            !start { print }
          ' README.md > temp.md && mv temp.md README.md

          echo "README.md updated successfully"

      - name: Commit and Push Changes
        run: |
          git config --local user.email "${{ secrets.GIT_EMAIL }}"
          git config --local user.name "${{ secrets.GIT_USERNAME }}"

          if [[ -n $(git status --porcelain) ]]; then
            git add README.md
            git commit -m "üìù Update Todoist stats"
            git push origin main
          else
            echo "No changes to commit"
